<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Powerd By Smarty MS</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 28px; background:#f4f6f8; color:#222; }
    h1 { margin:0 0 18px; font-size:20px; background:linear-gradient(90deg,#0066ff,#0099ff); color:#fff; display:inline-block; padding:10px 18px; border-radius:8px; }
    .card { background:#fff; max-width:720px; margin:20px auto; padding:18px; border-radius:10px; box-shadow:0 6px 20px rgba(10,20,40,0.06); text-align:left; }
    label { display:block; font-weight:600; margin-bottom:6px; }
    textarea,input { width:100%; box-sizing:border-box; padding:10px 12px; border-radius:8px; border:1px solid #d7dbe0; font-size:14px; resize:vertical; }
    .row { display:flex; gap:10px; margin-top:12px; }
    .row button, .row a { flex:1; padding:12px; border-radius:8px; border:none; font-weight:700; cursor:pointer; text-decoration:none; color:#fff; text-align:center; }
    .generate { background:#0066ff; }
    .copy { background:#00b894; }
    .preview { background:#0984e3; }
    .output { margin-top:14px; padding:10px; border-radius:8px; background:#f1f5f9; border:1px dashed #dbe7ff; word-break:break-all; }
    .note { font-size:13px; color:#555; margin-top:10px; }
    footer{ text-align:center; margin-top:16px; font-size:13px; color:#666; }
  </style>
</head>
<body>
  <h1>Powerd By Smarty MS</h1>

  <div class="card">
    <label for="inputUrl">Insert source URL (example: rarestudy.site link)</label>
    <textarea id="inputUrl" rows="4"></textarea>

    <div class="row" style="margin-top:12px;">
      <button class="generate" id="btnGenerate">Generate Now</button>
      <button class="copy" id="btnCopy">Copy</button>
    </div>

    <div class="output" id="outputBox">Final link will appear here after generation.</div>

    <div style="margin-top:10px;">
      <a id="previewLink" class="preview" href="#" target="_blank" style="display:inline-block; padding:10px 14px; border-radius:8px; color:#fff;">Preview</a>
    </div>

    <div class="note">
      Notes: The tool auto-extracts CDN (<code>sec-prod-mediacdn.pw.live</code>). If fails, paste direct CDN link containing <code>master.mpd</code>.
    </div>
  </div>

  <footer>© LEARN WITH JBKRIYANSH</footer>

  <script>
    const btnGenerate = document.getElementById('btnGenerate');
    const btnCopy = document.getElementById('btnCopy');
    const inputEl = document.getElementById('inputUrl');
    const out = document.getElementById('outputBox');
    const preview = document.getElementById('previewLink');

    function getQuery(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    // auto-fill if coming from cutcdn.html
    const autoSrc = getQuery("src");
    if (autoSrc) inputEl.value = decodeURIComponent(autoSrc);

    function makeFinalPlayerLink(m3u8) {
      return 'https://learnwithpw-recorded.onrender.com/play?v=' + encodeURIComponent(m3u8);
    }
    function replaceMpdToM3u8(u) {
      return u.replace(/master\.mpd/gi, 'master.m3u8');
    }
    function extractSecProdUrlFromText(text) {
      if (!text) return null;
      const re = /(https?:\/\/sec-prod-mediacdn\.pw\.live\/[^\s"'<>]+)/i;
      const m = text.match(re);
      if (m && m[1]) return m[1];
      const re2 = /(https?:\/\/[^\s"'<>]*master\.(?:mpd|m3u8)[^\s"'<>]*)/i;
      const m2 = text.match(re2);
      if (m2 && m2[1]) return m2[1];
      return null;
    }
    async function tryFetchAndExtract(url) {
      try {
        const resp = await fetch(url);
        if (!resp.ok) return null;
        const txt = await resp.text();
        return extractSecProdUrlFromText(txt);
      } catch(e) { return null; }
    }
    async function generate() {
      out.textContent = 'Working...';
      preview.href = '#';
      let val = inputEl.value.trim();
      if (!val) { alert('Please paste a URL first'); return; }

      let candidate = extractSecProdUrlFromText(val);
      if (!candidate) {
        if (/(master\.(mpd|m3u8))/i.test(val) || /sec-prod-mediacdn\.pw\.live/i.test(val)) {
          candidate = val;
        } else {
          const extracted = await tryFetchAndExtract(val);
          if (extracted) candidate = extracted;
        }
      }
      if (!candidate) {
        out.textContent = 'Could not extract CDN link.';
        alert('Extraction failed — paste direct CDN URL.');
        return;
      }

      const m3u8 = replaceMpdToM3u8(candidate);
      const final = makeFinalPlayerLink(m3u8);

      out.textContent = final;
      preview.href = final;
      preview.innerText = 'Preview';
      alert('Link Generated ✅');
    }
    btnGenerate.addEventListener('click', generate);
    btnCopy.addEventListener('click', async () => {
      const text = out.textContent.startsWith('http') ? out.textContent : '';
      if (!text) { alert('No generated link'); return; }
      try {
        await navigator.clipboard.writeText(text);
        alert('Link copied ✅');
      } catch (e) {
        prompt("Copy manually:", text);
      }
    });
  </script>
</body>
</html>
