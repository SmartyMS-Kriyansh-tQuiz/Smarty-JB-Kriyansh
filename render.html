<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Render Final CDN Link</title>
  <style>
    body{font-family:Inter,system-ui,Arial,sans-serif;background:#071025;color:#e6eef6;padding:20px;max-width:980px;margin:0 auto;}
    .card{background:#051423;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    h1{margin:0 0 8px;font-size:20px}
    pre{background:#02101a;padding:10px;border-radius:6px;overflow:auto;color:#bfeef2;max-height:200px}
    video{width:100%;max-height:480px;border-radius:8px;margin-top:12px;background:#000}
    .muted{color:#9ca3af;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Render Final CDN Link</h1>
    <div class="muted">This page reads <code>localStorage.final_render_link</code> and plays it. If you used the dashboard, it will open this page automatically.</div>

    <pre id="cdnLink">— loading converted CDN link —</pre>
    <pre id="renderLink">— final render link will appear here —</pre>

    <div style="margin-top:8px">
      <button id="copyBtn">Copy Render Link</button>
    </div>

    <video id="videoPlayer" controls playsinline muted></video>
  </div>

  <!-- Hls.js (optional for non-Safari) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <script>
    const KEY_FINAL = 'final_render_link';
    const cdnEl = document.getElementById('cdnLink');
    const renderEl = document.getElementById('renderLink');
    const video = document.getElementById('videoPlayer');

    function loadAndPlay(){
      const final = localStorage.getItem(KEY_FINAL) || '';
      renderEl.textContent = final || '— no final_render_link in localStorage —';
      cdnEl.textContent = localStorage.getItem('m3u8_converted_url') || '— m3u8_converted_url missing —';

      if(!final){
        return;
      }

      // If browser (Safari) supports native HLS:
      if(video.canPlayType('application/vnd.apple.mpegurl')){
        video.src = final;
        video.muted = true; // keep muted so autoplay works in some browsers
        video.play().catch(()=>console.log('Autoplay prevented'));
        return;
      }

      if(window.Hls){
        if(window._hlsInst) try{ window._hlsInst.destroy(); }catch(e){}
        const hls = new Hls();
        window._hlsInst = hls;
        hls.loadSource(final);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, function() {
          video.play().catch(()=>console.log('Autoplay prevented'));
        });
        hls.on(Hls.Events.ERROR, function(evt, data){
          console.warn('Hls error', data);
        });
        return;
      }

      // fallback:
      video.src = final;
    }

    document.getElementById('copyBtn').addEventListener('click', ()=>{
      const final = localStorage.getItem(KEY_FINAL) || '';
      if(!final) return alert('No final render link to copy.');
      navigator.clipboard.writeText(final).then(()=>alert('Copied render link to clipboard'));
    });

    loadAndPlay();
  </script>
</body>
</html>
